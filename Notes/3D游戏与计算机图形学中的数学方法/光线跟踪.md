# 光线跟踪

## 多项式的根

- 求解一条直线和一个表面之间交点的问题，通常需要计算一个关于 $t$ 的 n 阶多项式的根，直线的表达式如下

  $$
  P(t)=S+tV
  $$

  - 对于由平面组成的表面来说，多项式的阶数为 1
  - 对于由球面或者圆柱面等二次曲面组成的表面来说，多项式的阶数为 2
  - 对于更复杂的表面如样条曲面和圆环面，多项式的阶数为 3 或 4

### 二次多项式

- 二次方程的表达式如下

  $$
  at^2+bt+c=0
  $$
  解得
  $$
  t=\frac{-b\pm\sqrt{b^2-4ac}}{2a}
  $$

  - 上式就是著名的二次等式，令 $D=b^2-4ac$，称为多项式根的判别式，如果 $D\gt 0$，多项式有两个实根；如果 $D=0$，多项式有一个实根；如果 $D\lt 0$，多项式没有实根。利用多项式根的判别式，可以在不计算光线与对象表面的实际交点的情况下，判断光线与对象表面的相交情况

### 三次多项式

- 三次方程的表达式如下（已将三次项系数简化为 1）

  $$
  t^3+at^2+bt+c=0
  $$

- 令 $t=x-\frac{a}{3}$ 代入上式可得

  $$
  x^3+px+q=0
  $$
  其中
  $$
  p=-\frac{1}{3}a^2+b
  $$
  $$
  q=\frac{2}{27}a^3-\frac{1}{3}ab+c
  $$

- 解得 $x$ 即可得到 $t$ 的解
- 三次多项式的根的判别式 $D$

  $$
  D=-4p^3-27q^2
  $$

- 三次方程的三个复数根

  $$
  x_1=r+s \\
  x_2=\rho r+\rho^2s \\
  x_3=\rho^2r+\rho s
  $$
  其中
  $$
  r=\sqrt[3]{-\frac{1}{2}q+\sqrt{-\frac{1}{108}D}}
  $$
  $$
  s=\sqrt[3]{-\frac{1}{2}q-\sqrt{-\frac{1}{108}D}}
  $$
  $\rho$ 是完全立方根
  $$
  \rho=-\frac{1}{2}+i\frac{\sqrt{3}}{2}
  $$
  $$
  \rho^2=-\frac{1}{2}-i\frac{\sqrt{3}}{2}
  $$

- 根的判别式 $D$ 可以简化

  $$
  p'=\frac{p}{3}
  $$
  $$
  q'=\frac{q}{2}
  $$
  $$
  D'=\frac{D}{108}=-(p'^3+q'^2)
  $$
  $$
  r=\sqrt[3]{-q'+\sqrt{-D'}}
  $$
  $$
  s=\sqrt[3]{-q'-\sqrt{-D'}}
  $$

- 如果 $D'\lt 0$，方程仅有一个实数根 $x_1$
- 如果 $D'=0$，方程有两个不同实根

  $$
  x_1=2r \\
  x_2=x_3=(\rho+\rho^2)r=-r
  $$
- 如果 $D'\gt 0$，方程有三个不同实根，需要进行复数运算解得。一个利用三角恒等式的替代方法解得的根如下

  $$
  x_1=2\sqrt{-p'}\cos\theta
  $$
  $$
  x_2=2\sqrt{-p'}\cos(\theta+\frac{2\pi}{3})
  $$
  $$
  x_3=2\sqrt{-p'}\cos(\theta-\frac{2\pi}{3})
  $$
  其中
  $$
  \theta=\frac{1}{3}\cos^{-1}(\frac{-q'}{\sqrt{-p'^3}})
  $$

### 四次多项式

- 四次方程的表达式如下（已将四次项系数简化为 1）

  $$
  t^4+at^3+bt^2+ct+d=0
  $$

- 令 $t=x-\frac{a}{4}$ 代入上式可得

  $$
  x^4+px^2+px+r=0
  $$
  其中
  $$
  p=-\frac{3}{8}a^2+b
  $$
  $$
  q=\frac{1}{8}a^3-\frac{1}{2}ab+c
  $$
  $$
  r=-\frac{3}{256}a^4+\frac{1}{16}a^2b-\frac{1}{4}ac+d
  $$

- 解得 $x$ 即可得到 $t$ 的解
- 要解得四次方程的根，首先需要求解以下三次方程的根

  $$
  y^3-\frac{p}{2}y^2-ry+\frac{4rp-q^2}{8}=0
  $$

- 令 $y$ 是该方程的任一实数解，如果 $q\ge 0$ 则四次方程的解等于以下两个二次方程的解

  $$
  x^2+x\sqrt{2y-p}+y-\sqrt{y^2-r}=0 \\
  x^2-x\sqrt{2y-p}+y+\sqrt{y^2-r}=0
  $$

- 如果 $q\lt 0$，则四次方程的解等于以下两个二次方程的解

  $$
  x^2+x\sqrt{2y-p}+y+\sqrt{y^2-r}=0 \\
  x^2-x\sqrt{2y-p}+y-\sqrt{y^2-r}=0
  $$

### 牛顿方法

- Newton-Raphson 迭代法，简称牛顿法，是求任意连续函数的根的数值计算方法，该方法通过将与该函数及其导数相关的一个公式进行迭代计算而获得所需的根
- 对于函数 $f$，若计算它的根，首先假设已知该函数的一个初始猜测根 $x_0$，函数 $f$ 的曲线在点 $(x_0,f(x_0))$ 的切线的斜率等于导数 $f'(x_0)$，根据直线的点斜式表示法，可得切线方程的表达式

  $$
  y-f(x_0)=f'(x_0)(x-x_0)
  $$

- 可以看出，该切线与 $x$ 轴的交点距离函数 $f$ 的真正根比初始猜测根 $x_0$ 更近。当 $y=0$ 时，解关于 $x$ 的方程得

  $$
  x_{i+1}=x_i-\frac{f(x_i)}{f'(x_i)},\ i\ge 0
  $$

  - 重复计算上式可得一个数值系列 $x_0,x_1,x_2,\dots$，在正确条件下，该数值系列主键逼近函数 $f$ 的根
- 牛顿方法收敛非常快，可以证明牛顿方法具有平方收敛的特性，粗略地说，在一次迭代中，近似根的有效数字数将增加一倍
- 牛顿方法不总是能保证收敛到方程的一个解，特别是，当初始猜测值被选在函数导数为 0 的一点时，改点的切线是水平的，不与 x 轴相交，迭代过程将不能继续
- 为了保证收敛，尽量选离函数的真实根近的初始猜测值。当计算光线与一个复杂对象表面的交点时，通常首先计算光线与复杂对象的包围盒的交点，并以改点对应的数字作为初始猜测值

### 倒数与平方根的精细化

- 现代大多数 CPU 和图形硬件都具有倒数和平方根倒数的近似计算指令，可将一个数的倒数和平方根倒数近似到至少几位的精度，这些指令产生的结果可用牛顿法精确到更高的精度
- 通过计算以下方程的根可得到一个数 $r$ 的倒数

  $$
  f(x)=x^{-1}-r
  $$
  $$
  x_{n+1}=x_{n}-\frac{x_n^{-1}-r}{-x_n^{-2}}=x_n(2-rx_n)
  $$
  $$
  0\lt x_0\lt \frac{2}{r}
  $$

- 一个数 $r$ 的平方根可通过计算以下方程的正根得到

  $$
  f(x)=x^{-2}-r
  $$
  $$
  x_{n+1}=x_{n}-\frac{x_n^{-2}-r}{-2x_n^{-3}}=\frac{1}{2}x_n(3-rx_n^2)
  $$
  $$
  0\lt x_0\lt \sqrt{\frac{3}{r}}
  $$
  $$
  \sqrt{r}=r\cdot \frac{1}{\sqrt{r}}
  $$

## 表面求交

- 计算光线与表面在哪个点相交是光线跟踪算法的重点，光线方程如下

  $$
  P(t)=S+tV
  $$

  - $S$ 表示光线的起始位置，$V$ 表示光线的照射方向
- 除了三角形之外，光线与对象交点的计算都在对象空间执行，计算出交点后交点的坐标和表面在该点的法向量再变换回世界空间

### 光线与三角形的交点

- 一个三角形有空间中的三个顶点 $P_0$、$P_1$ 和 $P_2$ 的位置表示，三角形所在平面的法向量 $N$

  $$
  N=(P_1-P_0)\times(P_2-P_0)
  $$

- 选 $P_0$ 点，四维平面向量为 $L=(N,-N\cdot P_0)$，则光线方程与平面 $L$ 的交点处的 $t$ 值为

  $$
  t=-\frac{L\cdot S}{L\cdot V}
  $$

  - 如果 $L\cdot V=0$，则不存在交点，否则将 $t$ 值代入光线方程可得光线与三角形所在平面的交点 $P$
- 判断点 $P$ 是否位于三角形内部，可以通过计算点 $P$ 对于三角形三个顶点的重心坐标完成

  $$
  P=w_0P_0+w_1P_1+w_2P_2 \\
  w_0+w_1+w_2=1
  $$
  令
  $$
  R=P-P_0 \\
  Q_1=P_1-P_0 \\
  Q_2=P_2-P_0
  $$
  得
  $$
  \begin{bmatrix}w_1 \\ w_2\end{bmatrix}=
  \frac{1}{Q_1^2Q_2^2-(Q_1\cdot Q_2)^2}
  \begin{bmatrix}
  Q_2^2 & -Q_1\cdot Q_2 \\
  -Q_1\cdot Q_2 & Q_1^2
  \end{bmatrix}
  \begin{bmatrix}
  R\cdot Q_1 \\
  R\cdot Q_2
  \end{bmatrix}
  $$

  - 当且仅当 $w_0$、$w_1$ 和 $w_2$ 三个权值均为非负值时，点 $P$ 位于三角形内部，由于 $w_0=1-w_1-w_2$，则此时 $w_1+w_2\le 1$
  - 可以用这三个权值对顶点的属性信息进行插值

### 光线与立方盒相交

- 立方盒由 6 个平面组成，平面方程如下

  $$
  \begin{matrix}
  x=0 & x=r_x \\
  y=0 & y=r_y \\
  z=0 & z=r_z
  \end{matrix}
  $$

- 6 个平面中，最多考虑 3 个平面与光线相交，例如光线方向 $V$ 满足 $V_x=0$ 时光线与表面 $x=0$ 和 $x=r_x$ 平行，不相交；$V_x\gt 0$ 时光线照射到的平面 $x=r_x$ 是立方盒的内部面，不用进行相交测试；同理，$V_x\lt 0$ 时平面 $x=0$ 不用进行相交测试
- 得到光线与立方盒平面的交点后，还要判断该交点是否位于立方盒表面内部，可以通过简单判断坐标范围完成
- 得到一个交点后不用再进行相交测试，因为不会出现比该交点更近的交点

### 光线与球面相交

- 将半径为 $r$，中心在坐标系原点的球面的方程 $x^2+y^2+z^2=r^2$ 代入光线方程可解得光线与球面的交点

  $$
  a=V^2 \\
  b=2(S\cdot V) \\
  c=S^2-r^2
  $$

  - 计算根的判别式 $D=b^2-4ac$ 可以判断光线是否与球面相交
  - 如果 $D\gt 0$，则有两个不同交点，距离光源近的交点对应的 $t$ 值如下，因为 $a$ 总是一个正数

    $$
    t=\frac{-b-\sqrt{D}}{2a}
    $$

- 将椭球面方程 $x^2+m^2y^2+n^2z^2=r^2$ 代入光线方程可解得光线与椭球面的交点

  $$
  a=v_x^2+m^2V_y^2+n^2V_z^2 \\
  b=2(S_xV_x+m^2S_yV_y+n^2S_zV_z) \\
  c=S_x^2+m^2S_y^2+n^2S_z^2-r^2
  $$

### 光线与圆柱面相交

- x 轴半径为 $r$，y  轴半径为 $s$，高度为 $h$，底与 x-y 平面的坐标原点中心对齐的椭圆柱侧面表达式

  $$
  x^2+m^2y^2=r^2,\ 0\le z\le h
  $$

  - 其中 $m=r/s$，如果 $r=s$，则 $m=1$，椭圆柱为圆柱，代入光线方程得

    $$
    (V_x^2+m^2V_y^2)t^2+2(S_xV_x+m^2S_yV_y)t+S_x^2+m^2S_y^2-r^2=0
    $$

  - 与球面相同，根的判别式可以判断光线与柱面是否相交，解以上方程可得光线与 z 轴为中心线的无限长柱面的交点对应的 $t$，必须判断交点的 z 坐标是否满足 $0\le z\le h$，来进一步确认该交点是否与椭圆柱侧面相交
  - 碰撞检测算法中，经常遇到判断一个运动球体与表示多边形模型边的线段是否相交的问题，该问题可以转化成判断光线是否与一个给定半径和轴线端点的圆柱面相交的问题

### 光线与圆环相交

- 圆环表面的横截面有主半径 $r_1$ 和次半径 $r_2$。位于 x-y 平面半径为 $r_1$ 的圆是另外一个半径为 $r_2$ 的圆的圆心，第二个圆与第一个圆垂直，并绕 z 轴旋转。旋转圆的方程为

  $$
  s^2+z^2=r_2^2
  $$

  - s 值为在 x-y 平面内到主圆的距离
  
    $$
    s=\sqrt{x^2+y^2}-r_1
    $$

- 根据上两式得到圆环表达式

  $$
  (x^2+y^2+z^2+r_1^2-r_2^2)^2=4r_1^2(x^2+y^2)
  $$

- 上式代入光线方程可得

  $$
  at^4+bt^3+ct^2+dt+e=0
  $$
  其中
  $$
  \begin{cases}
  a=V^4 \\
  b=4V^2(S\cdot V) \\
  c=2V^2(S^2+r_1^2-r_2^2)-4r_1^2(V_x^2+V_y^2)+4(S\cdot V)^2 \\
  d=8r_1^2S_zV_z+4(S\cdot V)(S^2-r_1^2-r_2^2) \\
  e=S_x^4+S_y^4+S_z^4+2[S_x^2+S_y^2+S_z^2(r_1^2-r_2^2)+(S_x^2+S_y^2)(S_z^2-r_1^2-r_2^2)]
  \end{cases}
  $$

  - 上式除以 $a$ 可使首项的系数为 1，对其进行求解
  - 如果向量 $V$ 是规范化的，则上式可以简化

## 计算法向量

- 在某些情况下，用隐函数 $f(x,y,z)$ 可方便地表示一个表面，表面上任意一点 $(x,y,z)$ 满足 $f(x,y,z)=0$。假设表面上有一条曲线，有微分参数方程 $x(t)$、$y(t)$ 和 $z(t)$，则曲线在点 $(x(t),y(t),z(t))$ 的切线为

  $$
  T=(\frac{\mathrm{d}}{\mathrm{d}t}x(t),\frac{\mathrm{d}}{\mathrm{d}t}y(t),\frac{\mathrm{d}}{\mathrm{d}t}z(t))
  $$

- 该切线也与表面相切，根据微分的链式法则可得表面的法向量如下

  $$
  N=\nabla f(x,y,z)
  $$
  $$
  \nabla=i\frac{\partial}{\partial x}+j\frac{\partial}{\partial y}+k\frac{\partial}{\partial z}
  $$

  - $\nabla f(x,y,z)$ 称为函数 $f$ 在点 $(x,y,z)$ 处的梯度

## 反射与折射向量

### 反射向量计算

- 入射光线方向向量 $L$，反射光线方向向量 $R$，反射面单位法向量 $N$

  $$
  R=L-2perp_NL=L-2[L-(N\cdot L)N]=2(N\cdot L)N-L
  $$

### 折射向量计算

- 投射表面具有折射系数属性，根据 Snell 定律，入射角 $\theta_L$ 与折射角 $\theta_T$ 之间的关系如下

  $$
  \eta_L\sin\theta_L=\eta_T\sin\theta_T
  $$

  - $\eta_L$ 是光线离开的介质的折射系数，$\eta_T$ 是光线进入的介质的折射系数，空气的折射系数通常定位 1.00，折射系数越大，则在两种不同介质之间光线弯曲效果越明显
- 入射光线单位方向向量 $L$，折射面单位法向量 $N$，折射光线方向向量 $T$

  $$
  T=(\frac{\eta_L}{\eta_T}N\cdot L-\sqrt{1-\frac{\eta_L^2}{\eta_T^2}[1-(N\cdot L)^2]})N-\frac{\eta_L}{\eta_T}L
  $$

  - 如果 $\eta_L\gt \eta_T$，上式中的平方根里的数值可能为负
  - 仅当 $\sin\theta_L\le \eta_T/\eta_L$ 时，上式有效，如果平方根里的数值为负，则会出现全内反射，光线不被折射
