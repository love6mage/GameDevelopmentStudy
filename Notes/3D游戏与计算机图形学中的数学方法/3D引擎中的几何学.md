# 3D 引擎中的几何学

## 三维空间中的直线

- 已知 3D 空间中的两点 $P_1$ 和 $P_2$，通过这两点的直线的参数化表达式如下

  $$
  P(t)=(1-t)P_1+tP_2
  $$

  - $t$ 是任意实数，连接 $P_1$ 和 $P_2$ 的线段对应的 $t$ 值范围为 $[0,1]$
- 射线只有一个端点 $S$，并沿着某一方向 $V$ 无限延伸，射线的参数化方程如下

  $$
  P(t)=S+tV
  $$

  - $t$ 是大于等于 $0$ 的实数
  - 该式也常用来表示直线

### 点与直线间的距离

- 已知由端点 $S$ 和方向 $V$ 定义的直线，从点 $Q$ 到该直线的距离 $d$ 等于向量 $Q-S$ 中与该直线垂直的分量的大小，根据勾股定理（毕达哥拉斯定理）可得

  $$
  d^2=(Q-S)^2-[proj_V(Q-S)]^2=(Q-S)^2-[\frac{(Q-S)\cdot V}{V^2}V]^2
  $$

### 直线间的距离

- 二维空间中直线两条直线要么平行要么相交，三维空间中，两条直线既不平行也不相交的情况称为扭曲
- 假设有两条直线，其参数化方程为 $P_1(t)=S_1+t_1V_1$ 和 $P_2(t)=S_2+t_2V_2$，可以通过计算使 $\lVert P_1(t_1)-P_2(t_2)\rVert$ 最小的 $t_1$ 和 $t_2$ 的值来计算出两条扭曲直线间的最小距离

## 三维空间中的平面

- 已知一个三维点 $P$ 与法向量 $N$，则过点 $P$ 并与 $N$ 垂直的平面可以定义为满足 $N\cdot(Q-P)=0$ 的点 $Q$ 的集合，这些点与点 $P$ 的差与法向量垂直
- 平面方程通常表示如下

  $$
  Ax+By+Cz+D=0
  $$

  - $A$、$B$ 和 $C$ 是法向量 $N$ 的 $x$、$y$ 和 $z$ 分量
  - $D=-N\cdot P$
  - $\frac{|D|}{\lVert N\rVert}$ 是过原点与该平面平行的平面到该平面的偏移距离
- 法向量 $N$ 通常规范化为单位长度，这样可使以下方程成立

  $$
  d=N\cdot Q+D
  $$

  - $d$ 为从任一点 $Q$ 到该平面的符号距离，$d=0$ 则点 $Q$ 位于平面上，$d\gt 0$ 则点 $Q$ 位于平面法向量所指的一侧，称为平面的正向侧，$d\lt 0$ 则点 $Q$ 位于平面的负向侧
- 平面可简单表示为一个四维向量的形式，用 $(N,D)$ 表示由满足条件 $N\cdot Q+D=0$ 的 $Q$ 点组成的平面
- 如果将三维点看成 $w=1$ 的四维齐次坐标点，则

  $$
  d=L\cdot Q
  $$

  - 其中 $L=(N,D)$，$d=0$ 则点 $Q$ 位于平面上

### 直线和平面的交点

- 求一条直线与一个平面的交点是 3D 图形引擎中的普通操作，特别是在多边形裁剪中被广泛使用
- 直线 $P(t)=S+tV$ 和平面 $N\cdot Q+D=0$ 的交点可以求解以下关于 $t$ 的方程得到

  $$
  N\cdot P(t)+D=0
  $$
  解得
  $$
  t=\frac{-(N\cdot S+D)}{N\cdot V}
  $$

  - 将 $t$ 值代入直线方程可得交点
  - 如果 $N\cdot V=0$ 则直线与平面平行，此时若 $N\cdot S+D=0$ 则直线位于平面上，否则无交点
  - 可以写成四维平面表示形式，已知平面的四维表示形式为 $L=(N,D)$，$S$ 为 $w=1$ 的齐次点向量，$V$ 为 $w=0$ 的齐次方向向量，则

    $$
    t=-\frac{L\cdot S}{L\cdot V}
    $$

### 三个平面斜交

- 一个空间区域通常表示成由一系列平面为边界的凸多面体的形式，该多面体的边和顶点可以通过执行多次三个平面的求交运算得出
- 三个平面 $L_1=(N_1,D_1)$、$L_2=(N_2,D_2)$ 和 $L_3=(N_3,D_3)$ 的交点 $Q$ 可以求解以下方程组得出

  $$
  \begin{cases}
  L_1\cdot Q=0 \\
  L_2\cdot Q=0 \\
  L_3\cdot Q=0
  \end{cases}
  $$
  写成矩阵形式后解得
  $$
  Q=\begin{bmatrix}
  (N_1)_x & (N_1)_y & (N_1)_z \\
  (N_2)_x & (N_2)_y & (N_2)_z \\
  (N_3)_x & (N_3)_y & (N_3)_z
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  -D_1 \\ -D_2 \\ -D_3
  \end{bmatrix}
  $$

  - 如果上式 $3\times 3$ 矩阵是奇异矩阵，则这三个平面不相交于一点
- 两个不平行的平面 $L_1=(N_1,D_1)$ 和 $L_2=(N_2,D_2)$ 相交于一条直线，交线的方向 $V$ 与两个平面的法向量都垂直，可表示为 $V=N_1\times N_2$。为了获得交线的完整表达式，还需要直线上一点。为此，构造经过原点且法向量为 $V$ 的第三个平面 $L_3=(V,0)$，这可确保三个平面交于一点，该点即为两个不平行平面 $L_1$ 和 $L_2$ 交线上的一点

  $$
  Q=\begin{bmatrix}
  (N_1)_x & (N_1)_y & (N_1)_z \\
  (N_2)_x & (N_2)_y & (N_2)_z \\
  V_x & V_y & V_z
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  -D_1 \\ -D_2 \\ 0
  \end{bmatrix}
  $$

### 平面变换

- 如果要用一个 $3\times 3$ 矩阵 $M$ 和一个三维平移向量 $T$ 去变换平面，法向量 $N$ 可以用 $(M^{-1})^T$ 变换，变换后的平面到原点的符号距离可以通过下式计算

  $$
  D'=-((M^{-1})^TN)\cdot(MP+T)=D-N\cdot M^{-1}T
  $$

- 由 $M$ 和 $T$ 合成的 $4\times 4$ 矩阵 $F$ 如下

  $$
  F=\left [
  \begin{array}{c:c}
  M & T \\ \hline
  0 & 1
  \end{array}
  \right ]
  $$

  - $D-N\cdot M^{-1}T$ 正好等于 $(F^{-1})^T$ 的第四行与四维向量 $(N_x,N_y,N_z,D)$ 的內积，所以，平面的变换可以像三维法向量变换那样进行四维向量的变换，唯一不同的是平面变换中使用 $4\times 4$ 矩阵
- 采用 $4\times 4$ 矩阵的平面变换公式如下

  $$
  L'=(F^{-1})^TL
  $$

## 视锥

- 三维场景中，视锥是包含所有可视内容的空间体，形状像一个四棱锥，顶点位于虚拟相机
- 视锥与相机空间对齐，相机空间也称为观察空间，相机位于原点，x 轴向右，y 轴向上，z 轴方向则与 3D 图形库有关。OpenGL 图形库中 z 轴方向与相机指向相反，形成右手坐标系；Direct3D 中 z 轴方向与相机指向相同，形成左手坐标系

### 视场

- 投影平面是一个与相机指向垂直的平面，该平面与相机的距离为 $e$，有时称 $e$ 为相机的焦距。视锥左锥面和右锥面分别与投影平面在 $x=-1$ 和 $x=1$ 处相交，左锥面与右锥面的夹角 $\alpha$ 称为水平视场角，焦距越短，水平视场角越大

  $$
  e=\frac{1}{\tan(\alpha/2))}
  $$

- 屏幕的高宽比 $a$ 等于屏幕的高与宽的比例。视锥底锥面与顶锥面分别于投影平面在 $y=-a$ 与 $y=a$ 处相交，垂直视场角 $\beta$ 表达水如下

  $$
  \beta=2tan^{-1}(a/e)
  $$

- 视锥的四个边平面从投影平面切出一个长方形，该长方形与相机距离 $e$，四条边分别位于 $x=\pm1$ 和 $y=\pm a$ 处
- OpenGL 中，函数 `glFrustum()` 需要用户定义一个与相机距离为 $n$ 的长方形，其中 $n$ 是近锥平面距离。用比例系数 $n/e$ 缩放该长方形，则它的左边位于 $x=-n/e$，右边位于 $x=n/e$，底边位于 $y=-an/e$，顶边位于 $y=an/e$

### 锥平面

- OpenGL 的相机空间中的视锥平面向量如下表，其中 $e$ 为焦距，$a$ 为高宽比， $n$ 为近平面距离，$f$ 为远平面距离，所有平面的法向量指向视锥内部

  平面 | $(N,D)
  :- | :-
  近平面 | $(0,0,-1,-n)$
  远平面 | $(0,0,1,f)$
  左平面 | $(\frac{e}{\sqrt{e^2+1}},0,-\frac{1}{\sqrt{e^2+1}},0)$
  右平面 | $(-\frac{e}{\sqrt{e^2+1}},0,-\frac{1}{\sqrt{e^2+1}},0)$
  底平面 | $(0,\frac{e}{\sqrt{e^2+a^2}},-\frac{a}{\sqrt{e^2+a^2}},0)$
  上平面 | $(0,-\frac{e}{\sqrt{e^2+a^2}},-\frac{a}{\sqrt{e^2+a^2}},0)$

## 透视校正插值

- 当 3D 图形处理器在屏幕上渲染一个三角形时，要进行逐行的光栅化。三角形的顶点除了包含相机空间的位置信息外，还包含光照颜色和纹理映射坐标等信息，三角形面中的此类信息都要经过插值获得。当绘制三角形的一条扫描线时，每个像素的信息为左右两个顶点的同类信息的插值
- 在投影平面上的相同步随着三角形面与相机之间的距离增加而在三角形面上产生更大的步长，因此三角形面上的正确插值不是线性的
- 图形处理器必须采用非线性插值方法来计算纹理映射坐标，以避免纹理映射图形的扭曲变形。较老的图形卡仍然使用简单的线性插值来计算光照信息一类的信息，因为这些信息受插值方法的不同影响不大，不像纹理映射那样影响很明显

### 深度插值

- 三角形面上一点的 z 坐标（表示深度）可由 3D 图形硬件通过线性插值得到，不需要透视校正插值，因为三角形面上的插值点的 z 坐标值的倒数是线性插值

### 顶点属性插值

- 三角形面上的插值属性与 z 坐标值的倒数的乘积 $b/z$ 是线性插值。当光栅化一条扫描线时，图形处理器首先计算 $1/z$ 的线性插值，再计算其倒数，最后乘以 $b/z$ 的线性插值结果，则可获得顶点属性 $b$ 的透视校正插值结果
