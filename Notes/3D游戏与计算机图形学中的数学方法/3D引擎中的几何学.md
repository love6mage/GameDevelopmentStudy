# 3D 引擎中的几何学

## 三维空间中的直线

- 已知 3D 空间中的两点 $P_1$ 和 $P_2$，通过这两点的直线的参数化表达式如下

  $$
  P(t)=(1-t)P_1+tP_2
  $$

  - $t$ 是任意实数，连接 $P_1$ 和 $P_2$ 的线段对应的 $t$ 值范围为 $[0,1]$
- 射线只有一个端点 $S$，并沿着某一方向 $V$ 无限延伸，射线的参数化方程如下

  $$
  P(t)=S+tV
  $$

  - $t$ 是大于等于 $0$ 的实数
  - 该式也常用来表示直线

### 点与直线间的距离

- 已知由端点 $S$ 和方向 $V$ 定义的直线，从点 $Q$ 到该直线的距离 $d$ 等于向量 $Q-S$ 中与该直线垂直的分量的大小，根据勾股定理（毕达哥拉斯定理）可得

  $$
  d^2=(Q-S)^2-[proj_V(Q-S)]^2=(Q-S)^2-[\frac{(Q-S)\cdot V}{V^2}V]^2
  $$

### 直线间的距离

- 二维空间中直线两条直线要么平行要么相交，三维空间中，两条直线既不平行也不相交的情况称为扭曲
- 假设有两条直线，其参数化方程为 $P_1(t)=S_1+t_1V_1$ 和 $P_2(t)=S_2+t_2V_2$，可以通过计算使 $\lVert P_1(t_1)-P_2(t_2)\rVert$ 最小的 $t_1$ 和 $t_2$ 的值来计算出两条扭曲直线间的最小距离

## 三维空间中的平面

- 已知一个三维点 $P$ 与法向量 $N$，则过点 $P$ 并与 $N$ 垂直的平面可以定义为满足 $N\cdot(Q-P)=0$ 的点 $Q$ 的集合，这些点与点 $P$ 的差与法向量垂直
- 平面方程通常表示如下

  $$
  Ax+By+Cz+D=0
  $$

  - $A$、$B$ 和 $C$ 是法向量 $N$ 的 $x$、$y$ 和 $z$ 分量
  - $D=-N\cdot P$
  - $\frac{|D|}{\lVert N\rVert}$ 是过原点与该平面平行的平面到该平面的偏移距离
- 法向量 $N$ 通常规范化为单位长度，这样可使以下方程成立

  $$
  d=N\cdot Q+D
  $$

  - $d$ 为从任一点 $Q$ 到该平面的符号距离，$d=0$ 则点 $Q$ 位于平面上，$d\gt 0$ 则点 $Q$ 位于平面法向量所指的一侧，称为平面的正向侧，$d\lt 0$ 则点 $Q$ 位于平面的负向侧
- 平面可简单表示为一个四维向量的形式，用 $(N,D)$ 表示由满足条件 $N\cdot Q+D=0$ 的 $Q$ 点组成的平面
- 如果将三维点看成 $w=1$ 的四维齐次坐标点，则

  $$
  d=L\cdot Q
  $$

  - 其中 $L=(N,D)$，$d=0$ 则点 $Q$ 位于平面上

### 直线和平面的交点

- 求一条直线与一个平面的交点是 3D 图形引擎中的普通操作，特别是在多边形裁剪中被广泛使用
- 直线 $P(t)=S+tV$ 和平面 $N\cdot Q+D=0$ 的交点可以求解以下关于 $t$ 的方程得到

  $$
  N\cdot P(t)+D=0
  $$
  解得
  $$
  t=\frac{-(N\cdot S+D)}{N\cdot V}
  $$

  - 将 $t$ 值代入直线方程可得交点
  - 如果 $N\cdot V=0$ 则直线与平面平行，此时若 $N\cdot S+D=0$ 则直线位于平面上，否则无交点
  - 可以写成四维平面表示形式，已知平面的四维表示形式为 $L=(N,D)$，$S$ 为 $w=1$ 的齐次点向量，$V$ 为 $w=0$ 的齐次方向向量，则

    $$
    t=-\frac{L\cdot S}{L\cdot V}
    $$

### 三个平面斜交

- 一个空间区域通常表示成由一系列平面为边界的凸多面体的形式，该多面体的边和顶点可以通过执行多次三个平面的求交运算得出
- 三个平面 $L_1=(N_1,D_1)$、$L_2=(N_2,D_2)$ 和 $L_3=(N_3,D_3)$ 的交点 $Q$ 可以求解以下方程组得出

  $$
  \begin{cases}
  L_1\cdot Q=0 \\
  L_2\cdot Q=0 \\
  L_3\cdot Q=0
  \end{cases}
  $$
  写成矩阵形式后解得
  $$
  Q=\begin{bmatrix}
  (N_1)_x & (N_1)_y & (N_1)_z \\
  (N_2)_x & (N_2)_y & (N_2)_z \\
  (N_3)_x & (N_3)_y & (N_3)_z
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  -D_1 \\ -D_2 \\ -D_3
  \end{bmatrix}
  $$

  - 如果上式 $3\times 3$ 矩阵是奇异矩阵，则这三个平面不相交于一点
- 两个不平行的平面 $L_1=(N_1,D_1)$ 和 $L_2=(N_2,D_2)$ 相交于一条直线，交线的方向 $V$ 与两个平面的法向量都垂直，可表示为 $V=N_1\times N_2$。为了获得交线的完整表达式，还需要直线上一点。为此，构造经过原点且法向量为 $V$ 的第三个平面 $L_3=(V,0)$，这可确保三个平面交于一点，该点即为两个不平行平面 $L_1$ 和 $L_2$ 交线上的一点

  $$
  Q=\begin{bmatrix}
  (N_1)_x & (N_1)_y & (N_1)_z \\
  (N_2)_x & (N_2)_y & (N_2)_z \\
  V_x & V_y & V_z
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  -D_1 \\ -D_2 \\ 0
  \end{bmatrix}
  $$

### 平面变换

- 如果要用一个 $3\times 3$ 矩阵 $M$ 和一个三维平移向量 $T$ 去变换平面，法向量 $N$ 可以用 $(M^{-1})^T$ 变换，变换后的平面到原点的符号距离可以通过下式计算

  $$
  D'=-((M^{-1})^TN)\cdot(MP+T)=D-N\cdot M^{-1}T
  $$

- 由 $M$ 和 $T$ 合成的 $4\times 4$ 矩阵 $F$ 如下

  $$
  F=\left [
  \begin{array}{c:c}
  M & T \\ \hline
  0 & 1
  \end{array}
  \right ]
  $$

  - $D-N\cdot M^{-1}T$ 正好等于 $(F^{-1})^T$ 的第四行与四维向量 $(N_x,N_y,N_z,D)$ 的內积，所以，平面的变换可以像三维法向量变换那样进行四维向量的变换，唯一不同的是平面变换中使用 $4\times 4$ 矩阵
- 采用 $4\times 4$ 矩阵的平面变换公式如下

  $$
  L'=(F^{-1})^TL
  $$

## 视锥

- 三维场景中，视锥是包含所有可视内容的空间体，形状像一个四棱锥，顶点位于虚拟相机
- 视锥与相机空间对齐，相机空间也称为观察空间，相机位于原点，x 轴向右，y 轴向上，z 轴方向则与 3D 图形库有关。OpenGL 图形库中 z 轴方向与相机指向相反，形成右手坐标系；Direct3D 中 z 轴方向与相机指向相同，形成左手坐标系

### 视场

- 投影平面是一个与相机指向垂直的平面，该平面与相机的距离为 $e$，有时称 $e$ 为相机的焦距。视锥左锥面和右锥面分别与投影平面在 $x=-1$ 和 $x=1$ 处相交，左锥面与右锥面的夹角 $\alpha$ 称为水平视场角，焦距越短，水平视场角越大

  $$
  e=\frac{1}{\tan(\alpha/2))}
  $$

- 屏幕的高宽比 $a$ 等于屏幕的高与宽的比例。视锥底锥面与顶锥面分别于投影平面在 $y=-a$ 与 $y=a$ 处相交，垂直视场角 $\beta$ 表达水如下

  $$
  \beta=2tan^{-1}(a/e)
  $$

- 视锥的四个边平面从投影平面切出一个长方形，该长方形与相机距离 $e$，四条边分别位于 $x=\pm1$ 和 $y=\pm a$ 处
- OpenGL 中，函数 `glFrustum()` 需要用户定义一个与相机距离为 $n$ 的长方形，其中 $n$ 是近锥平面距离。用比例系数 $n/e$ 缩放该长方形，则它的左边位于 $x=-n/e$，右边位于 $x=n/e$，底边位于 $y=-an/e$，顶边位于 $y=an/e$

### 锥平面

- OpenGL 的相机空间中的视锥平面向量如下表，其中 $e$ 为焦距，$a$ 为高宽比， $n$ 为近平面距离，$f$ 为远平面距离，所有平面的法向量指向视锥内部

  平面 | $(N,D)$
  :- | :-
  近平面 | $(0,0,-1,-n)$
  远平面 | $(0,0,1,f)$
  左平面 | $(\frac{e}{\sqrt{e^2+1}},0,-\frac{1}{\sqrt{e^2+1}},0)$
  右平面 | $(-\frac{e}{\sqrt{e^2+1}},0,-\frac{1}{\sqrt{e^2+1}},0)$
  底平面 | $(0,\frac{e}{\sqrt{e^2+a^2}},-\frac{a}{\sqrt{e^2+a^2}},0)$
  上平面 | $(0,-\frac{e}{\sqrt{e^2+a^2}},-\frac{a}{\sqrt{e^2+a^2}},0)$

## 透视校正插值

- 当 3D 图形处理器在屏幕上渲染一个三角形时，要进行逐行的光栅化。三角形的顶点除了包含相机空间的位置信息外，还包含光照颜色和纹理映射坐标等信息，三角形面中的此类信息都要经过插值获得。当绘制三角形的一条扫描线时，每个像素的信息为左右两个顶点的同类信息的插值
- 在投影平面上的相同步随着三角形面与相机之间的距离增加而在三角形面上产生更大的步长，因此三角形面上的正确插值不是线性的
- 图形处理器必须采用非线性插值方法来计算纹理映射坐标，以避免纹理映射图形的扭曲变形。较老的图形卡仍然使用简单的线性插值来计算光照信息一类的信息，因为这些信息受插值方法的不同影响不大，不像纹理映射那样影响很明显

### 深度插值

- 三角形面上一点的 z 坐标（表示深度）可由 3D 图形硬件通过线性插值得到，不需要透视校正插值，因为三角形面上的插值点的 z 坐标值的倒数是线性插值

### 顶点属性插值

- 三角形面上的插值属性与 z 坐标值的倒数的乘积 $b/z$ 是线性插值。当光栅化一条扫描线时，图形处理器首先计算 $1/z$ 的线性插值，再计算其倒数，最后乘以 $b/z$ 的线性插值结果，则可获得顶点属性 $b$ 的透视校正插值结果

## 投影

- 为了将三维场景渲染在二维屏幕上，场景中的每个顶点需要投影到投影平面上。对于位于点 $P$ 的顶点，计算从原点发出的照向点 $P$ 的一束光线与投影平面的交点，可以得出该顶点在投影平面的投影位置。投影点的 x 和 y 坐标如下

  $$
  x=-\frac{e}{P_z}x
  $$
  $$
  y=-\frac{e}{P_z}y
  $$

  - 使用上式无法得到 z 坐标，因此 3D 图形系统使用四维空间的齐次坐标对顶点进行投影

### 透视投影

- 透视投影可将顶点的 x 和 y 坐标投影到投影平面的正确位置，而同时保留深度信息。通过将视锥映射到立方体可实现透视投影，该立方体是齐次裁剪空间在 3D 空间的投影，在 OpenGL 中，它的中心与坐标系原点重合，分别沿 x，y 和 z 坐标轴 -1 扩展到 +1。到齐次裁剪空间的映射首先用一个 $4\times 4$ 投影矩阵将相机空间的点的负 z 坐标添加到变化点的 w 坐标，接着除以 w 坐标则得到一个有规范化设备坐标的三维点
- 令 $P=(P_x,P_y,P_z,1)$ 是相机空间中的一个齐次坐标点，该点位于视锥内部。在 OpenGL 中，函数 `glFrustum()` 的参数包括一个矩形的四边形，即左边 $x=l$，右边 $x=r$，底边 $y=b$，顶边 $y=t$，该矩形是有视锥的四个边平面在近平面上裁出的，近平面位于 $z=-n$ 处，远平面位于 $z=-f$ 处。3D 点 $P'=(x',y',z')$ 除以 w 后可得到与其对应的 4D 齐次坐标点

  $$
  P'=(-x'P_z,-y'P_z,-z'P_z,-P_z)
  $$
  其中
  $$
  \begin{cases}
  -x'P_z=\frac{2n}{r-l}P_x+\frac{r+l}{r-l}P_z \\
  -y'P_z=\frac{2n}{t-b}P_y+\frac{t+b}{t-b}P_z \\
  -z'P_z=-\frac{f+n}{f-n}P_z-\frac{2nf}{f-n}
  \end{cases}
  $$
  得到透视投影矩阵
  $$
  P'=M_{frustum}P=\begin{bmatrix}
  \frac{2n}{r-l} & 0 & \frac{r+l}{r-l} & 0 \\
  0 & \frac{2n}{t-b} & \frac{t+b}{t-b} & 0 \\
  0 & 0 & -\frac{f+n}{f-n} & -\frac{2nf}{f-n} \\
  0 & 0 & -1 & 0
  \end{bmatrix}
  \begin{bmatrix}
  P_x \\ P_y \\ P_z \\ 1
  \end{bmatrix}
  $$
  允许远平面距离无穷大的无限投影矩阵
  $$
  M_{infinity}=\lim_{f\rightarrow\infty}M_{frustum}=\begin{bmatrix}
  \frac{2n}{r-l} & 0 & \frac{r+l}{r-l} & 0 \\
  0 & \frac{2n}{t-b} & \frac{t+b}{t-b} & 0 \\
  0 & 0 & -1 & -2n \\
  0 & 0 & -1 & 0
  \end{bmatrix}
  $$

- $M_{infinity}$ 允许渲染深度大于等于 n 的对象，同时还允许对 $w=0$ 的顶点进行渲染。相机空间中的点 $Q=(Q_x,Q_y,Q_z,0)$ 为沿方向 $(Q_x,Q_y,Q_z)$ 与相机距离无限远的点

  $$
   M_{infinity}Q==\begin{bmatrix}
  \frac{2n}{r-l} & 0 & \frac{r+l}{r-l} & 0 \\
  0 & \frac{2n}{t-b} & \frac{t+b}{t-b} & 0 \\
  0 & 0 & -1 & -2n \\
  0 & 0 & -1 & 0
  \end{bmatrix}
  \begin{bmatrix}
  Q_x \\ Q_y \\ Q_z \\ 0
  \end{bmatrix}=
  \begin{bmatrix}
  \frac{2n}{r-l}Q_x+\frac{r+l}{r-l}Q_z \\
  \frac{2n}{t-b}Q_y+\frac{t+b}{t-b}Q_z \\
  -Q_z \\ -Q_z
  \end{bmatrix}
  $$

### 正投影

- 正投影也称为平行投影，相机空间的点总是被与相机观察方向平行的光线映射到投影平面，不会出现透视扭曲现象，所以向规范化设备坐标系的映射可分别在三个坐标轴上线性执行，将 x，y 和 z 坐标分别从区间 $[l,r]$，$[b,t]$ 和 $[-f,-n]$ 映射到 $[-1,1]$，得到的正投影矩阵如下，变换后的 w 坐标为 1。$M_{ortho}$ 在 OpenGL 中由函数 `glOrtho()` 函数产生

  $$
  P'=M_{ortho}P=\begin{bmatrix}
  \frac{2}{r-l} & 0 & 0 & -\frac{r+l}{r-l} \\
  0 & \frac{2}{t-b} & 0 & -\frac{t+b}{t-b} \\
  0 & 0 & \frac{-2}{f-n} & -\frac{f+n}{f-n} \\
  0 & 0 & 0 & 1
  \end{bmatrix}
  \begin{bmatrix}
  P_x \\ P_y \\ P_z \\ 1
  \end{bmatrix}
  $$

### 提取锥平面

- 裁剪空间的平面表示向量 $L'$ 如下

  平面 | $(N,D)$
  :- | :-
  近平面 | $(0,0,1,1)$
  远平面 | $(0,0,-1,1)$
  左平面 | $(1,0,0,1)$
  右平面 | $(-1,0,0,1)$
  底平面 | $(0,1,0,1)$
  上平面 | $(0,-1,0,1)$

- $L'$ 对应的相机空间的平面 $L$ 的计算公式

  $$
  L=[(M^{-1})^{-1}]^TL'=M^TL'
  $$

- 用 $M_i$ 表示矩阵 $M$ 的第 $i$ 行，则相机空间的视锥平面表达式如下，这些表达式得出的平面表示向量不是单位向量，需要重新缩放

  $$
  near=M_4+M_3 \\
  far=M_4-M_3 \\
  left=M_4+M_1 \\
  right=M_4-M_1 \\
  bottom=M_4+M_2 \\
  top=M_4-M_2
  $$

  - 对无限投影矩阵以外的任意投影矩阵有效
  - 如果视锥的焦距和宽高比已知，用[规范化锥平面计算公式](#锥平面)更高效

## 镜像和倾斜裁剪

- 在很多场景中，包含像镜面或水面一样的反射表面，需要渲染这些表面中的反射图像。典型的方法是建立一个专门的图像缓冲区，称为反射缓冲，保存场景中在反射面中可见的物体的渲染结果。当渲染反射面几何时，从反射缓冲区读出相应的颜色混合到最终图像中
- 反射场景通过一个虚拟相机渲染，该虚拟相机与主相机关于反射面对称
- 虚拟相机坐标系与主相机坐标系的偏手性不同，OpenGL 中可以调用 `glFrontFace()` 简易翻转前向三角形的坐标顺序使其适合裁剪
- 处理虚拟相机渲染时，一些几何体与相机之间的距离比反射面到相机的距离近（物体位于反射面两侧），这时位于反射面背部的部分在反射中将被翻转。如果该几何体在反射中被渲染，则最终的渲染图像会产生不期望的结果。这类问题的一个简单解决方法是定义一个用户裁剪平面将位于反射面的几何体裁剪掉。Eric Lengyel 充分利用每个渲染场景中都存在的视锥裁剪平面的一个便捷方法如下
  - 通过修改反射矩阵，将视锥的近平面变换到与反射平面相同，可省略定义多余的第 7 个裁剪平面，反射平面通常与普通视锥相倾斜
  - 令 $C=(C_x,C_y,C_z,C_w)$ 为新的近平面，坐标为相机空间坐标，相机位于裁剪平面的背面，所以可以假设 $C_w\lt 0$

    $$
    \mu C=M_4+M_3
    $$

  - 投影矩阵 $M$ 第四行是顶点属性的透视校正插值必需的，所以只能改变第三行

    $$
    M_3'=\mu C-M_4
    $$

  - 新的远平面

    $$
    F=M_4-M_3'=2M_4-\mu C
    $$

  - 令 $C'$ 为 $C$ 在裁剪空间的投影，$Q$ 为视锥中离平面 $C$ 最远的点，$Q'$ 为 $Q$ 在裁剪空间中的投影，则

    $$
    Q'=(sgn(C_x'),sgn(C_y'),1,1)
    $$

  - 对于大多数投影，令 $C_x'$ 和 $C_y'$ 的符号与 $C_x$ 和 $C_y$ 相同是可行的，因此可避免 C 到裁剪空间的投影，可以先获得 $Q'$ 的各个分量，然后使用 $Q=M^{-1}Q'$ 得到 $Q$
  - 为使远平面包含点 $Q$，必须使 $F\cdot Q=0$，解得

    $$
    \mu=\frac{2M_4\cdot Q}{C\cdot Q}
    $$

    - 该方法可使远平面与近平面的夹角尽量小。对于无线投影矩阵，需要使新的远平面与视锥的两个边平面的公共边平行
  - 对透视投影矩阵，有 $M_4=(0,0,-1,0)$，因此

    $$
    M_3=\frac{-2Q_z}{C\cdot Q}C+(0,0,1,0)
    $$
