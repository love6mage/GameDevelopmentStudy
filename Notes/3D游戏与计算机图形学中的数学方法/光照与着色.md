# 光照与着色

## RGB 颜色

- RGB 颜色系中，颜色表示为红、绿、蓝三个分量组成的三元组的形式，这三个分量的取值范围从 0 到 1。该颜色不但表示人眼能够感知的色彩的光谱组成，还可表示光的强度。颜色 $\mathcal{C}$ 可写成 $\mathcal{C}=(\mathcal{C}_r,\mathcal{C}_g,\mathcal{C}_b)$ 的形式

  $$
  s\mathcal{C}=(s\mathcal{C}_r,s\mathcal{C}_g,s\mathcal{C}_b) \\
  \mathcal{C}+\mathcal{D}=(\mathcal{C}_r+\mathcal{D}_r,\mathcal{C}_g+\mathcal{D}_g,\mathcal{C}_b+\mathcal{D}_b) \\
  \mathcal{C}\mathcal{D}=(\mathcal{C}_r\mathcal{D}_r,\mathcal{C}_g\mathcal{D}_g,\mathcal{C}_b\mathcal{D}_b)
  $$

  - 颜色的乘法称为颜色调制。渲染三角形中一个像素的颜色通常由多种不同来源的颜色混合而成，三角形面中的像素的颜色通常为从纹理映射图查到的颜色与从三角形顶点插值而来的颜色相乘的乘积，这时，称纹理颜色被顶点颜色调制

## 光源

### 环境光源

- 低强度光源，近似表示场景中某一区域的大概亮度，环境光的颜色值 $\mathcal{A}$ 通常为一常数，也可以是空间位置坐标的函数

### 平行光源

- 无限远光源，发出的光是平行的，光源在有限空间中没有具体位置，照射距离也是无限的，强度不会随距离的增加而减弱

### 点光源

- 从空间中一点向各个方向发出的等强度的光的光源，发出的光的强度随传播距离增加而减弱
- OpenGL 和 Direct3D 利用二次多项式的倒数给出强度的一般公式，如果点光源位于点 $P$，它发出的光照射在点 $Q$ 上的强度 $\mathcal{C}$ 为

  $$
  \mathcal{C}=\frac{1}{k_c+k_ld+k_qd^2}\mathcal{C}_0
  $$

  - $\mathcal{C}_0$ 是光的颜色值，$d$ 是光源到点 $Q$ 的距离，常数 $k_d$、$k_l$ 和 $k_q$ 分别为常数衰减系数、线性衰减系数和二次衰减系数
  - 距离光源的位置超过某一距离后，光的强度要故意设置为 0，限制点光源的影响范围，省略该范围外物体对该光源的渲染计算

### 聚光灯光源

- 与点光源类似，但是有一个首选方向，且会以聚光灯效果系数衰减
- 在一个点 $P$ 处放置一个聚光灯光源，光源方向向量为 $R$，它发出的光照射在点 $Q$ 上的强度 $\mathcal{C}$ 为

  $$
  \mathcal{C}=\frac{\max\{-R\cdot L,0\}^p}{k_c+k_ld+k_qd^2}\mathcal{C}_0
  $$

  - $\mathcal{C}_0$ 是光的颜色值，$d$ 是光源到点 $Q$ 的距离，常数 $k_d$、$k_l$ 和 $k_q$ 为衰减系数，$L$ 是从 $Q$ 指向光源位置 $P$ 的单位向量，指数 $p$ 控制聚光灯光源发出的光的聚集程度
  - 较大的 $p$ 值对应一束高聚光度的光，衰减很快；较小的 $p$ 值对应一束低聚光度的光，衰减慢
  - 当 $R=-L$ 时聚光灯光源发出的光最强，强度随 $R$ 与 $-L$ 夹角的增大而减弱
  - $R$ 与 $-L$ 夹角超过 90 度时，聚光灯光源发出的光不会照射到这些点

## 漫反射

- 如果漫反射表面法向量与光线方向之间的夹角为 $\theta$，则表面单位面积上的光强度衰减因子为 $\cos\theta$，该因子可以由表面单位法向量 $N$ 与反射点指向光源的单位向量 $L$ 的內积得到。表面上的点 $Q$ 反射到观察者的颜色 $\mathcal{K}$ 如下

  $$
  \mathcal{K}_{diffuse}=\mathcal{DA+D}\sum_{i=1}^{n}\mathcal{C}_i\max\{N\cdot L_i,0\}
  $$

  - $C_i$ 为第 $i$ 个光源在点 $Q$ 处照射的光的强度，点 $Q$ 的反射光的颜色被表面漫反射颜色 $\mathcal{D}$ 调制

## 镜面反射

- 表面上点 $Q$ 反射到观察者的颜色 $\mathcal{K}$ 如下

  $$
  \mathcal{K}_{specular}=\mathcal{S}\sum_{i=1}^n\mathcal{C}_i\max\{R_i\cdot V,0\}^m(N\cdot L_i\gt 0)
  $$

  - $\mathcal{S}$ 为镜面反射颜色值，$C_i$ 为第 $i$ 个光源在点 $Q$ 处照射的光的强度，$R$ 为反射向量，$V$ 为 $Q$ 点到观察者的向量，$L$ 为 $Q$ 点到光源的单位向量，$N$ 为法向量，$m$ 控制镜面高光的锐度，较小的 $m$ 值产生一个呆板的高光效果，衰减距离较大；较大的 $m$ 值产生一个锐利的高光效果，当向量 $R$ 和 $V$ 分散时迅速衰减
  - $R\cdot V$ 可以替换为 $N\cdot H$，$H$ 为向量 $L$ 和向量 $V$ 的中间向量
