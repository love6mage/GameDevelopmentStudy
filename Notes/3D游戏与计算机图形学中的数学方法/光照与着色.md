# 光照与着色

## RGB 颜色

- RGB 颜色系中，颜色表示为红、绿、蓝三个分量组成的三元组的形式，这三个分量的取值范围从 0 到 1。该颜色不但表示人眼能够感知的色彩的光谱组成，还可表示光的强度。颜色 $\mathcal{C}$ 可写成 $\mathcal{C}=(\mathcal{C}_r,\mathcal{C}_g,\mathcal{C}_b)$ 的形式

  $$
  s\mathcal{C}=(s\mathcal{C}_r,s\mathcal{C}_g,s\mathcal{C}_b) \\
  \mathcal{C}+\mathcal{D}=(\mathcal{C}_r+\mathcal{D}_r,\mathcal{C}_g+\mathcal{D}_g,\mathcal{C}_b+\mathcal{D}_b) \\
  \mathcal{C}\mathcal{D}=(\mathcal{C}_r\mathcal{D}_r,\mathcal{C}_g\mathcal{D}_g,\mathcal{C}_b\mathcal{D}_b)
  $$

  - 颜色的乘法称为颜色调制。渲染三角形中一个像素的颜色通常由多种不同来源的颜色混合而成，三角形面中的像素的颜色通常为从纹理映射图查到的颜色与从三角形顶点插值而来的颜色相乘的乘积，这时，称纹理颜色被顶点颜色调制

## 光源

### 环境光源

- 低强度光源，近似表示场景中某一区域的大概亮度，环境光的颜色值 $\mathcal{A}$ 通常为一常数，也可以是空间位置坐标的函数

### 平行光源

- 无限远光源，发出的光是平行的，光源在有限空间中没有具体位置，照射距离也是无限的，强度不会随距离的增加而减弱

### 点光源

- 从空间中一点向各个方向发出的等强度的光的光源，发出的光的强度随传播距离增加而减弱
- OpenGL 和 Direct3D 利用二次多项式的倒数给出强度的一般公式，如果点光源位于点 $P$，它发出的光照射在点 $Q$ 上的强度 $\mathcal{C}$ 为

  $$
  \mathcal{C}=\frac{1}{k_c+k_ld+k_qd^2}\mathcal{C}_0
  $$

  - $\mathcal{C}_0$ 是光的颜色值，$d$ 是光源到点 $Q$ 的距离，常数 $k_d$、$k_l$ 和 $k_q$ 分别为常数衰减系数、线性衰减系数和二次衰减系数
  - 距离光源的位置超过某一距离后，光的强度要故意设置为 0，限制点光源的影响范围，省略该范围外物体对该光源的渲染计算

### 聚光灯光源

- 与点光源类似，但是有一个首选方向，且会以聚光灯效果系数衰减
- 在一个点 $P$ 处放置一个聚光灯光源，光源方向向量为 $R$，它发出的光照射在点 $Q$ 上的强度 $\mathcal{C}$ 为

  $$
  \mathcal{C}=\frac{\max\{-R\cdot L,0\}^p}{k_c+k_ld+k_qd^2}\mathcal{C}_0
  $$

  - $\mathcal{C}_0$ 是光的颜色值，$d$ 是光源到点 $Q$ 的距离，常数 $k_d$、$k_l$ 和 $k_q$ 为衰减系数，$L$ 是从 $Q$ 指向光源位置 $P$ 的单位向量，指数 $p$ 控制聚光灯光源发出的光的聚集程度
  - 较大的 $p$ 值对应一束高聚光度的光，衰减很快；较小的 $p$ 值对应一束低聚光度的光，衰减慢
  - 当 $R=-L$ 时聚光灯光源发出的光最强，强度随 $R$ 与 $-L$ 夹角的增大而减弱
  - $R$ 与 $-L$ 夹角超过 90 度时，聚光灯光源发出的光不会照射到这些点

## 漫反射

- 如果漫反射表面法向量与光线方向之间的夹角为 $\theta$，则表面单位面积上的光强度衰减因子为 $\cos\theta$，该因子可以由表面单位法向量 $N$ 与反射点指向光源的单位向量 $L$ 的內积得到。表面上的点 $Q$ 反射到观察者的颜色 $\mathcal{K}$ 如下

  $$
  \mathcal{K}_{diffuse}=\mathcal{DA+D}\sum_{i=1}^{n}\mathcal{C}_i\max\{N\cdot L_i,0\}
  $$

  - $C_i$ 为第 $i$ 个光源在点 $Q$ 处照射的光的强度，点 $Q$ 的反射光的颜色被表面漫反射颜色 $\mathcal{D}$ 调制

## 镜面反射

- 表面上点 $Q$ 反射到观察者的颜色 $\mathcal{K}$ 如下

  $$
  \mathcal{K}_{specular}=\mathcal{S}\sum_{i=1}^n\mathcal{C}_i\max\{R_i\cdot V,0\}^m(N\cdot L_i\gt 0)
  $$

  - $\mathcal{S}$ 为镜面反射颜色值，$C_i$ 为第 $i$ 个光源在点 $Q$ 处照射的光的强度，$R$ 为反射向量，$V$ 为 $Q$ 点到观察者的向量，$L$ 为 $Q$ 点到光源的单位向量，$N$ 为法向量，$m$ 控制镜面高光的锐度，较小的 $m$ 值产生一个呆板的高光效果，衰减距离较大；较大的 $m$ 值产生一个锐利的高光效果，当向量 $R$ 和 $V$ 分散时迅速衰减
  - $R\cdot V$ 可以替换为 $N\cdot H$，$H$ 为向量 $L$ 和向量 $V$ 的中间向量

## 纹理映射

- 表面上任一点颜色值由从各个纹理图中查找到的纹理元素与光照公式按一定方式混合而成，一个最简单的纹理映射是从漫反射纹理图中查找出一个采样值，并用它对漫反射颜色调制
- 令颜色值 $\mathcal{T}$ 为与表面上一点对应的来自纹理图的筛选采样值

  $$
  \mathcal{K}_{diffuse}=\mathcal{DTA+DT}\sum_{i=1}^{n}\mathcal{C}_i\max\{N\cdot L_i,0\}
  $$

- 用来调制镜面反射分量的纹理图称为光泽图，令颜色值 $\mathcal{G}$ 为来自光泽图的采样值

  $$
  \mathcal{K}_{specular}=\mathcal{SG}\sum_{i=1}^n\mathcal{C}_i\max\{R_i\cdot V,0\}^m(N\cdot L_i\gt 0)
  $$

- 从纹理图采样得到的实际颜色由应用到物体表面的纹理坐标决定，每个顶点可能有 1~4 个纹理坐标，分别用 s、t、p 和 q 表示

### 标准纹理图

- 一个纹理坐标可以查找一维纹理图，两个纹理坐标可以查找二维纹理图，三个纹理坐标可以查找三维纹理图，纹理图的全部宽带、高度和深度分别与 s、t 和 p 方向上的 0 和 1 之间的坐标值对应

### 投影纹理图

- 第四个纹理坐标用于投影纹理映射，纹理坐标 q 的作用在大多数情况下与齐次坐标中的 w 坐标相同，默认值为 1，坐标 s、t 和 p 的插值要除以 q 的插值
- 投影映射的一个典型应用是模拟一个聚光灯光源将一幅图像投影到环境中

### 立方纹理图

- 立方纹理图是另外一种对物体进行纹理映射的方法，通常用于模拟模型表面的环境映射效果
- 一个立方纹理图由 6 个二维分量组成，这些分量分别对应立方体的 6 个面，以立方体中心为起点的方向向量指向的纹理元素为采样像素。方向向量中，绝对值最大的那个坐标决定对立方纹理图的哪个面采样，其余两个坐标被该坐标除后，可被映射到 $[0,1]$  区间，用该坐标可对立方纹理图中相应面的二维纹理图进行采样
- 立方纹理图的纹理坐标是在运行时实时产生的
- 在一些图形硬件中，立方纹理图可用来规范化向量。规范化立方图的每个面中保存的不是颜色图像，而是 RGB 颜色编码的向量；规范化立方图每个面上的像素中保存的是采样该像素的单位向量，在执行像素级的光照计算时，规范化立方图是必需的，因为对三角形表面法向量插值时经常产生小于单位长度的法向量

### 滤波和多级纹理

- 多级纹理，一系列纹理图像，每个较小图像的宽和高分别是较大图像的一半。最大图像为 0 级，其次为 1 级，以此类推，纹理坐标导数越大，对应的多级纹理图像的级别越高。令二维纹理图的宽为 $2^n$ 高为 $2^m$，$s(x,y)$ 和 $t(x,y)$ 是将观察窗口的坐标 x 和 y 变换成纹理坐标的映射函数，$u(x,y)=2^ns(x,y)$，$v(x,y)=2^mt(x,y)$，则多级细节参数 $\lambda$ 的计算公式为

  $$
  \rho_x=\sqrt{(\frac{\partial u}{\partial x})^2+(\frac{\partial v}{\partial x})^2}
  $$
  $$
  \rho_y=\sqrt{(\frac{\partial u}{\partial y})^2+(\frac{\partial v}{\partial y})^2}
  $$
  $$
  \lambda=\log_2[\max(\rho_x,\rho_y)]
  $$

- 当模型离相机越来越近时，观察窗口的分辨率与纹理图的分别率相比通常会变大，如果只使用一个采样值会在渲染结果中出现块状像素显示，因此可用双线性滤波方法取纹理图中每个纹理像素的四个采样值并加权混合。假设一个二维纹理图的高度为 h，宽度为 w，用纹理坐标 $(s,t)$ 对其采样，则双线性滤波纹理值 $\mathcal{T}$ 为

  $$
  \mathcal{T}=(1-\alpha)(1-\beta)\mathcal{T}_{(i,j)}+ \alpha(1-\beta)\mathcal{T}_{(i+1,j)}+ (1-\alpha)\beta \mathcal{T}_{(i,j+1)}+\alpha\beta\mathcal{T}_{(i+1,j+1)}
  $$
  其中
  $$
  i=\lfloor ws-\frac{1}{2} \rfloor
  $$
  $$
  j=\lfloor ht-\frac{1}{2} \rfloor
  $$
  $$
  \alpha=\mathrm{frac}(ws-\frac{1}{2})
  $$
  $$
  \beta=\mathrm{frac}(ht-\frac{1}{2})
  $$

- 当模型靠近或远离相机时，多级纹理的不连续性会导致不美观的显示效果，因此一些渲染硬件提供了三线性滤波方法，该方法将采样自 $|\lambda|$ 和 $|\lambda|+1$ 级纹理的颜色值 $\mathcal{T}_1$ 和 $\mathcal{T}_2$ 线性混合

  $$
  \mathcal{T}=(1-\mathrm{frac}(\lambda))\mathcal{T}_1+\mathrm{frac}(\lambda)\mathcal{T}_2
  $$

## 发射映射

- 为了给物体增加发射均匀火光的效果，在光照公式中增加一个发光颜色 $\mathcal{E}$，用发光图可对发光颜色值进行调制，发光图表示表面上每点发出的光的颜色和强度，用 $\mathcal{M}$ 表示发光图的一个过滤采样，则光照公式中的发光颜色部分可简单表示为下式

  $$
  \mathcal{K=EM}
  $$

## 着色模型

- 与多种纹理图结合，计算三角形表面光照效果的方法称为着色

### 计算法向量

- 利用顶点向量的外积可以计算出一个三角形的法向量，对个顶点分别位于点 $P_0$、$P_1$ 和 $P_2$ 的三角形的单位法向量为

  $$
  N=\frac{(P_1-P_0)\times(P_2-P_0)}{\lVert (P_1-P_0)\times(P_2-P_0)\rVert}
  $$

- 三角形一个顶点的法向量为该顶点所在的全部三角形法向量的平均值

  $$
  N_{vertex}=\frac{\sum_{i=1}^kN_i}{\lVert \sum_{i=1}^kN_i\rVert}
  $$

  - 可以使用下式计算非规范化法向量再计算平均值，这样面积大的三角形的法向量对平均法向量的影响也大

    $$
    N=(P_1-P_0)\times(P_2-P_0)
    $$

### Gouraud 着色

- 首先计算每个顶点处的光照，然后用顶点颜色通过插值计算三角形内部点的光照。每个顶点的漫反射和镜面反射色如下

  $$
  \mathcal{K}_{primary}=\mathcal{E+DA+D}\sum_{i=1}^{n}\mathcal{C}_i\max\{N\cdot L_i,0\}
  $$
  $$
  \mathcal{K}_{secondary}=\mathcal{S}\sum_{i=1}^n\mathcal{C}_i\max\{N\cdot H_i,0\}^m(N\cdot L_i\gt 0)
  $$

- 三角形面上最终的像素颜色如下式，其中 $\mathcal{T}$ 为纹理图采样，操作符 $\circ$ 表示纹理混合的调制操作或者相加操作

  $$
  \mathcal{K}=\mathcal{K}_{primary}\circ\mathcal{T}_1\circ\mathcal{T}_2\circ\cdots\circ\mathcal{T}_k+\mathcal{K}_{secondary}
  $$

### Blinn-Phong 着色

- 对顶点法向量 $N$、指向光源的方向 $L$ 和指向观察的方向 $V$ 进行插值，计算每个像素的光照公式

  $$
  \mathcal{K}=\mathcal{K}_{emission}+\mathcal{K}_{diffuse}+\mathcal{K}_{specular}\\
  =\mathcal{EM+DTA+}\sum_{i=1}^n\mathcal{C}_i[\mathcal{DT}(N\cdot L_i)+\mathcal{SG}(N\cdot H_i)^m(N\cdot L_i>0)]
  $$

- 与 Gouraud 着色相比，能产生相当好的高光效果
- 插值法向量不能像顶点法向量那样保持单位长度，这个问题可以通过直接规范化插值法向量解决，也可以利用规范化立方图获得

## 凹凸映射

- 凹凸映射使用位图扰动每一像素的法向量，以产生像素级的细节

### 构造凹凸图

- 凹凸图中的每个向量表示三角形任一点的插值法向量应指向的法向量方向，向量 $(0,0,1)$ 表示未扰动的法向量
- 一个典型的凹凸图由高度图中提取的法向量组成

### 切向量空间

- 需要在每个顶点处定义一个坐标系，使顶点法向量总是指向 z 轴正方向，除了该法向量，还需要两个与表面相切的向量，从而构成一个坐标系的正交基，最终所得坐标系称为切向量空间或顶点空间
- 对于由参数方程表示的表面，通过计算相对每个参数的导数可得相应的切向量

### 计算切向量

- 要使顶点空间的 x 坐标轴对应凹凸图中的方向 s，y 坐标轴对应凹凸图中的方向 t，即如果 Q 表示三角形面上一点，则需要下式成立

  $$
  Q-P_0=(s-s_0)T+(t-t_0)B
  $$

  - 其中，T 和 B 为与纹理图对齐的切向量，$P_0$ 为三角形的一个顶点位置，$(s_0,t_0)$ 为该顶点对应的纹理坐标，B 与 T 正交
  - 可以用上式关系构造方程计算三角形的非规范化切向量 T 和 B，可以通过计算相邻三角形切向量的平均值求出一个点的切向量，但当相邻三角形的纹理映射不连续时相邻边界上的顶点切向量要重复保存，相邻三角形的切向量也不能平均
- 顶点位于 $P_0$、$P_1$ 和 $P_2$ 的三角形的切向量 T 和双切线 B 的计算公式如下

  $$
  \begin{bmatrix}
  T_x & T_y & T_z \\
  B_x & B_y & B_z
  \end{bmatrix}=\frac{1}{s_1t_2-s_2t_1}
  \begin{bmatrix}
  t_2 & -t_1 \\ -s_2 & s_1
  \end{bmatrix}
  \begin{bmatrix}
  (Q_1)_x & (Q_1)_y & (Q_1)_z \\
  (Q_2)_x & (Q_2)_y & (Q_2)_z
  \end{bmatrix}
  $$
  其中
  $$
  Q_1=P_1-P_0 \\
  Q_2=P_2-P_0 \\
  (s_1,t_1)=(s_1-s_0,t_1-t_0) \\
  (s_2,t_2)=(s_2-s_0,t_2-t_0)
  $$

- 指向光源的向量 L 和中间向量 H 被以下矩阵从对象空间变换到顶点空间

  $$
  \begin{bmatrix}
  T'_x & T'_y & T'_z \\
  B'_x & B'_y & B'_z \\
  N_x & N_y & N_z
  \end{bmatrix}
  $$

- 由于 B 可以由 N 和 T 求出，不必额外保存每个顶点的双切线 B

### 实现凹凸映射

- 着色时，凹凸映射被分为两部分，一部分为顶点的计算，另一部分为对像素的计算

## 物理反射模型

### TODO