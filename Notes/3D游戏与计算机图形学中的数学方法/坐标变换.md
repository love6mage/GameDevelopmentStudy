# 坐标变换

## 线性变换

- 假设坐标系 $C'$ 中的的坐标 $(x',y',z')$ 可以表示为坐标 $C$ 中的 $(x,y,z)$ 坐标的线性函数，下式构成了从坐标 $C$ 到坐标 $C'$ 的一个线性变换

  $$
  x'(x,y,z)=U_1x+V_1y+W_1z+T_1 \\
  y'(x,y,z)=U_2x+V_2y+W_2z+T_2 \\
  z'(x,y,z)=U_3x+V_3y+W_3z+T_3
  $$
  $$
  \begin{bmatrix}x' \\ y' \\ z'\end{bmatrix}=
  \begin{bmatrix}
  U_1 & V_1 & W_1 \\
  U_2 & V_2 & W_2 \\
  U_3 & V_3 & W_3
  \end{bmatrix}
  \begin{bmatrix}x \\ y \\ z\end{bmatrix}+
  \begin{bmatrix}T_1 \\ T_2 \\ T_3\end{bmatrix}
  $$

- 假设上述线性变换可逆，则 $C'$ 坐标系到 $C$ 坐标系的线性变换如下

  $$
  \begin{bmatrix}x \\ y \\ z\end{bmatrix}=
  \begin{bmatrix}
  U_1 & V_1 & W_1 \\
  U_2 & V_2 & W_2 \\
  U_3 & V_3 & W_3
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  \begin{bmatrix}x' \\ y' \\ z'\end{bmatrix}-
  \begin{bmatrix}T_1 \\ T_2 \\ T_3\end{bmatrix}
  \end{bmatrix}
  $$

- 多个线性变换可以合并起来用一个矩阵和平移向量表示

### 正交矩阵

- 计算机图形学应用中，多数的 $3\times 3$ 矩阵是正交矩阵
- **定义 1**：一个可逆的 $n\times n$ 矩阵 $M$，当且仅当 $M^{-1}=M^T$ 时，矩阵 $M$ 为正交矩阵
- **定理 2**：如果一组向量 $V_1,V_2,\cdots,V_n$ 形成一个标准正交向量组，对所有的 $1\le j\le n$，令 $n\times n$ 矩阵的第 $j$ 列，等于向量 $V_j$，构成的矩阵为正交矩阵
- **定理 3**：如果 $n\times n$ 矩阵 $M$ 是正交矩阵，该矩阵可保持被变换向量的长度和角度
- 正交矩阵可保持坐标系的整体结构不变，因此仅可用于旋转变换和反射变换或二者的组合变换

### 偏手性

- 三维空间中，由 3D 向量 $V_1$、$V_2$ 和 $V_3$ 组成的坐标系的基 $\mathfrak{B}$ 具有偏手性，当 $(V_1\times V_2)\cdot V_3\gt 0$ 时，$\mathfrak{B}$ 称为右手螺旋基。在右手坐标系中，向量 $V_1$ 和 $V_2$ 外积的方向遵循右手螺旋定律，与向量 $V_3$ 的方向之间的夹角为锐角。如果 $\mathfrak{B}$ 为右手螺旋正交基，则 $V_1\times V_2=V_3$。反之，当 $(V_1\times V_2)\cdot V_3\lt 0$ 时，$\mathfrak{B}$ 称为右手螺旋基
- 奇数次反射变换将改变基 $\mathfrak{B}$ 的偏手性，偶数次反射变换总是等效于旋转变换，因此一系列任意多的反射变换可以当做一个旋转变换加最多一个反射变换
- 通过计算一个 $3\times 3$ 矩阵 $M$ 的行列式可以判断该矩阵是否包含反射变换，如果行列式是负值则矩阵 $M$ 包含一个反射变换，将改变它所变换的基向量集的偏手性，反之如果行列式是正值则矩阵 $M$ 将保持变换基向量集的偏手性
- 正交矩阵 $M$ 的行列式的值只能为 1 或 -1，如果 $\det{M}=1$，则矩阵 $M$ 表示一个纯粹的旋转变换，如果 $\det{M}=-1$，则矩阵 $M$ 表示一个旋转变换和一个反射变换

## 比例变换

- 均匀比例变换，在 x，y 和 z 轴方向的变换比例相同

  $$
  P'=\begin{bmatrix}
  a & 0 & 0 \\
  0 & a & 0 \\
  0 & 0 & a
  \end{bmatrix}
  \begin{bmatrix}
  P_x \\ P_y \\ P_z
  \end{bmatrix}
  $$

- 非均匀比例变换，对向量在 x，y 和 z 轴方向采用不同比例进行变换

  $$
  P'=\begin{bmatrix}
  a & 0 & 0 \\
  0 & b & 0 \\
  0 & 0 & c
  \end{bmatrix}
  \begin{bmatrix}
  P_x \\ P_y \\ P_z
  \end{bmatrix}
  $$

- 延三个任意坐标轴的非均匀比例变换，可以先进行从 $(U,V,W)$  坐标系到 $(i,j,k)$ 坐标系的变换，然后按上式进行比例变换，最后将结果变换回 $(U,V,W)$ 坐标系

  $$
  P'=\begin{bmatrix}
  U_x & V_x & W_x \\
  U_y & V_y & W_y \\
  U_z & V_z & W_z
  \end{bmatrix}
  \begin{bmatrix}
  a & 0 & 0 \\
  0 & b & 0 \\
  0 & 0 & c
  \end{bmatrix}
  \begin{bmatrix}
  U_x & V_x & W_x \\
  U_y & V_y & W_y \\
  U_z & V_z & W_z
  \end{bmatrix}^{-1}
  \begin{bmatrix}
  P_x \\ P_y \\ P_z
  \end{bmatrix}
  $$

## 旋转变换

- 绕轴 A 旋转的角度有正负之分，规定向轴 A 的负方向看时，逆时针旋转对应的角度为正
- 绕 x，y 和 z 轴旋转 $\theta$ 角的 $3\times 3$ 旋转变换，其中 $s=\sin{\theta},c=\cos{\theta}$

  $$
  R_x(\theta)=\begin{bmatrix}
  1 & 0 & 0 \\
  0 & c & -s \\
  0 & s & c
  \end{bmatrix}
  $$
  $$
  R_y(\theta)=\begin{bmatrix}
  c & 0 & s \\
  0 & 1 & 0 \\
  -s & 0 & c
  \end{bmatrix}
  $$
  $$
  R_z(\theta)=\begin{bmatrix}
  c & -s & 0 \\
  s & c & 0 \\
  0 & 0 & 1
  \end{bmatrix}
  $$

- 向量绕任意轴的旋转变换可以通过将问题简化为向量中与轴单位向量垂直的分量的旋转问题求得

## 齐次坐标

### 四维变换矩阵

- 给三维点 $P$ 增加第四个坐标 $w=1$，可以将其坐标变为四维，变换矩阵也变为 $4\times 4$ 矩阵

  $$
  \begin{bmatrix}x' \\ y' \\ z'\end{bmatrix}=
  \begin{bmatrix}
  U_1 & V_1 & W_1 \\
  U_2 & V_2 & W_2 \\
  U_3 & V_3 & W_3
  \end{bmatrix}
  \begin{bmatrix}x \\ y \\ z\end{bmatrix}+
  \begin{bmatrix}T_1 \\ T_2 \\ T_3\end{bmatrix}
  $$
  $$
  \begin{bmatrix}x' \\ y' \\ z' \\ 1\end{bmatrix}=
  \begin{bmatrix}
  U_1 & V_1 & W_1 & T_1 \\
  U_2 & V_2 & W_2 & T_2 \\
  U_3 & V_3 & W_3 & T_3 \\
  0 & 0 & 0 & 1
  \end{bmatrix}
  \begin{bmatrix}x \\ y \\ z \\ 1\end{bmatrix}
  $$

- 为点 $P$ 的变换构造 $4\times 4$ 变换矩阵

  $$
  P'=MP+T
  $$
  $$
  F=\left [
  \begin{array}{c:c}
  M & T \\ \hline
  0 & 1
  \end{array}
  \right ]
  $$
  $$
  F^{-1}=\left [
  \begin{array}{c:c}
  M^{-1} & -M^{-1}T \\ \hline
  0 & 1
  \end{array}
  \right ]
  $$

### 点与方向

- 平移变换中，表示点的向量要发生改变，表示方向的向量保持不变，可以给方向向量增加第四个坐标 $w=0$ 消除 $4\times 4$ 变换矩阵对方向向量的影响

### 坐标 w 的几何意义

- 假设一个 4D 点向量 $P=(x,y,z,w),\ w\neq 0$，令向量 $\widetilde{P}$ 为向量 $P$ 在 $w=1$ 的三维空间的映射

  $$
  \widetilde{P}=(\frac{x}{w},\frac{y}{w},\frac{z}{w})
  $$

  - 3D 点向量 $\widetilde{P}$ 为点 $P$ 与坐标系原点的连线与 $w=1$ 的三维空间的交点，因此，给 4D 向量 $P$ 乘以任意比例系数都对应三维空间中的相同点

## 法向量变换

- 法向量和切向量是最常见的顶点附加信息。变换后的切向量可以用变换后的两个顶点向量之间的差表示，如果在顶点变换中用了 $3\times 3$ 矩阵 $M$，也可以用矩阵 $M$ 进行变换。法向量的变换更复杂些
- 法向量和切向量不受平移变换的影响，所以使用 $3\times 3$ 变换矩阵，但是用一个非正交矩阵变换法向量时，变换后的法向量常常与表面不垂直
- 法向量和切向量总是垂直的，同一个顶点的法向量 $N$ 和切向量 $T$ 满足 $T\cdot N=0$，变换后的法向量 $N'$ 和切向量 $T'$ 也满足该方程，给定一个变换矩阵 $M$，$T'=MT$，假设法向量的变换矩阵为 $G$，则

  $$
  N'\cdot T'=(GN)\cdot (MT)=0
  $$

  - 解得 $G=(M^{-1})^T$，必须如此变换的向量称为共变向量，以矩阵 $M$ 为变换矩阵的普通方式进行变换的向量称为逆变向量
  - 如果矩阵 $M$ 为正交矩阵，则 $G=M$，可以避免变换矩阵的求逆和转置操作
